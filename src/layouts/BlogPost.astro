---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import { ClientRouter } from "astro:transitions";
import BaseHead from "../components/BaseHead.astro";
import StructuredData from "../components/StructuredData.astro";
import BreadcrumbSchema from "../components/BreadcrumbSchema.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import ReadingTimeDisplay from "../components/ReadingTimeDisplay.astro";
import { PERSONAL_INFO, SITE_TITLE } from "../consts";

type Props = CollectionEntry<"blog">["data"] & {
  readingTime?: {
    minutesRead?: string;
    readingTimeMinutes?: number;
    wordCount?: number;
  };
};

const {
  title,
  description,
  publishDate,
  updatedDate,
  heroImage,
  readingTime,
  tags,
} = Astro.props;

// Extract the blog slug from pathname (remove /blog/ prefix and trailing slash)
const blogSlug = Astro.url.pathname.replace(/^\/blog\//, "").replace(/\/$/, "");
---

<html lang="en">
  <head>
    <BaseHead
      title={title}
      description={description}
      image={heroImage}
      type="article"
      publishDate={publishDate}
      tags={tags}
    />
    <StructuredData
      type="BlogPosting"
      pageUrl={Astro.url.href}
      title={title}
      description={description}
      publishDate={publishDate}
      updatedDate={updatedDate}
      readingTime={readingTime?.readingTimeMinutes}
      wordCount={readingTime?.wordCount}
    />
    <BreadcrumbSchema
      items={[
        { name: SITE_TITLE, url: Astro.site!.toString() },
        { name: "Blog", url: `${Astro.site}blog/` },
        { name: title, url: Astro.url.href },
      ]}
    />
  </head>

  <body>
    <ClientRouter />
    <Header />
    <main class="mx-auto my-4 w-full max-w-4xl px-6 pt-14">
      <article itemscope itemtype="https://schema.org/BlogPosting">
        <div class="prose prose-lg text-text-secondary mx-auto max-w-3xl px-4">
          {
            heroImage && (
              <Image
                width={1440}
                height={720}
                src={heroImage}
                alt={`Hero image for ${title}`}
                class="mb-8 h-auto w-full rounded-lg"
                transition:name={`hero-${blogSlug}`}
              />
            )
          }
          <div class="border-border mb-8 border-b pb-8 text-center">
            <div class="mb-4">
              <div class="text-text-muted mb-2 text-base">
                <time
                  itemprop="datePublished"
                  datetime={publishDate.toISOString()}
                >
                  <FormattedDate date={publishDate} />
                </time>
              </div>
              <ReadingTimeDisplay
                minutesRead={readingTime?.minutesRead}
                wordCount={readingTime?.wordCount}
                className="mb-2 justify-center"
              />
              {
                updatedDate && (
                  <div class="text-text-subtle text-sm italic">
                    Last updated on{" "}
                    <time
                      itemprop="dateModified"
                      datetime={updatedDate.toISOString()}
                    >
                      <FormattedDate date={updatedDate} />
                    </time>
                  </div>
                )
              }
            </div>
            <h1
              class="text-text-primary mb-0 text-4xl leading-tight font-bold md:text-5xl"
              itemprop="headline"
            >
              {title}
            </h1>

            <!-- Author information for SEO -->
            <meta itemprop="author" content={PERSONAL_INFO.name} />
            <link itemprop="url" href={Astro.url.href} />
          </div>

          <!-- Tags Section -->
          {
            tags && tags.length > 0 && (
              <section class="mb-8">
                <div class="flex flex-wrap justify-center gap-2">
                  {tags.map((tag) => (
                    <a
                      href={`/blog/tags/${tag}/`}
                      rel="tag"
                      class="bg-bg-secondary border-border hover:border-accent hover:text-accent inline-block rounded-full border px-3 py-1 text-sm transition-colors duration-200"
                    >
                      #{tag}
                    </a>
                  ))}
                </div>
              </section>
            )
          }

          <!-- Main Content -->
          <section class="blog-content">
            <slot />
          </section>
        </div>
      </article>
    </main>
    <Footer />
  </body>
</html>
